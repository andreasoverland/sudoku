<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>Sudoku-shuffle-stuff</title>
		<style>
			body,
			td {
				font-family: Verdana, Geneva, Tahoma, sans-serif;
				font-size: 14px;
			}

			table {
				border-spacing: 0;
				border-collapse: collapse;
			}

			td {
				text-align: center;
				width: 20px;
				height: 20px;
			}

			td:nth-child(4n-1) {
				width: 5px;
			}

			tr:nth-child(4n+6) td {
				height: 10px;
			}

			td.num {
				border: 1px solid lightgrey;
				font-size: 12px;
				color: #00b;
			}
			
			td.match {
				font-weight: bold;
			}

			.switches {
				padding: 5px;
			}

			.switches button {
				border: solid 1px #aaf;
				border-radius: 5px;
				display: inline-block;
				background: #aaf;
				padding: 5px 10px;
			}

			.tables {
				display: flex;
			}

			.table-container {
				margin-right: 50px;
			}
			
			td.matches_0 {
				background-color: rgba(255,100,100,0.2);
			}
			td.matches_1 {
				background-color: rgba(0,255,0,0.1);
			}
			td.matches_2 {
				background-color: rgba(0,255,0,0.2);
			}
			td.matches_3 {
				background-color: rgba(0,255,0,0.3);
			}
			td.matches_4 {
				background-color: rgba(0,255,0,0.4);
			}
			td.matches_5 {
				background-color: rgba(0,255,0,0.5);
			}
			td.matches_6 {
				background-color: rgba(0,255,0,0.6);
			}
			td.matches_7 {
				background-color: rgba(0,255,0,0.7);
			}
			td.matches_8 {
				background-color: rgba(0,255,0,0.8);
			}
			td.matches_9 {
				background-color: rgba(100,125,255,0.9);
			}
			
			textarea {
				text-align: right;
				font-family: "Courier New",monospace;
			}
		</style>
	</head>


	<body>

		<div class="tables">
			<div class="table-container">

				<table id="arranger">
					<tr>
						<td></td><td></td><td></td><td>A</td><td>A</td><td>A</td><td></td><td>B</td><td>B</td><td>B</td><td></td><td>C</td><td>C</td><td>C</td>
					</tr>
					<tr>
						<td></td><td></td><td></td><td>D</td><td>E</td><td>F</td><td></td><td>G</td><td>H</td><td>I</td><td></td><td>J</td><td>K</td><td>L</td>
					</tr>

					<tr>
						<td>m</td><td>p</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>m</td><td>q</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>m</td><td>r</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr class="separator-row">
						<td colspan="15"></td>
					</tr>

					<tr>
						<td>n</td><td>s</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>n</td><td>t</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>n</td><td>u</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr class="separator-row">
						<td colspan="15"></td>
					</tr>

					<tr>
						<td>o</td><td>v</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>o</td><td>x</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>o</td><td>y</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

				</table>

			</div>
			<div class="table-container">

				<table id="original">
					<tr>
						<td></td><td></td><td></td><td>A</td><td>A</td><td>A</td><td></td><td>B</td><td>B</td><td>B</td><td></td><td>C</td><td>C</td><td>C</td>
					</tr>
					<tr>
						<td></td><td></td><td></td><td>D</td><td>E</td><td>F</td><td></td><td>G</td><td>H</td><td>I</td><td></td><td>J</td><td>K</td><td>L</td>
					</tr>

					<tr>
						<td>m</td><td>p</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>m</td><td>q</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>m</td><td>r</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>


					<tr class="separator-row">
						<td colspan="15"></td>
					</tr>

					<tr>
						<td>n</td><td>s</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>n</td><td>t</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>n</td><td>u</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr class="separator-row">
						<td colspan="15"></td>
					</tr>

					<tr>
						<td>o</td><td>v</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>o</td><td>x</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

					<tr>
						<td>o</td><td>y</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td><td></td><td class="num">.</td><td class="num">.</td><td class="num">.</td>
					</tr>

				</table>

			</div>
			<textarea id="digitmaps" cols="81" rows="10"></textarea>
			
		</div>
		<div class="switches">
			<br />

			<button onclick="switchVerticalGroups(0,1);redraw();">AAA <-> BBB</button>
			<button onclick="switchVerticalGroups(0,2);redraw();">AAA <-> CCC</button>
			<button onclick="switchVerticalGroups(1,2);redraw();">BBB <-> CCC</button>

			<br />

			<button onclick="switchHorizontalGroups(0,1);redraw();">mmm <-> nnn</button>
			<button onclick="switchHorizontalGroups(0,2);redraw();">mmm <-> ooo</button>
			<button onclick="switchHorizontalGroups(1,2);redraw();">nnn <-> ooo</button>

			<br />

			<button onclick="rotateLeft();redraw();">Rotate CCW</button>
			<button onclick="rotateRight();redraw();">Rotate CW</button>

			<br />

			<button onclick="mirrorHorizontally();redraw();">Mirror left/right</button>
			<button onclick="mirrorVertically();redraw();">Mirror up/down</button>

			<br />

			<button onclick="switchCols(0,1);redraw();displayDigitMaps()">D <-> E</button>
			<button onclick="switchCols(0,2);redraw();">D <-> F</button>
			<button onclick="switchCols(1,2);redraw();">E <-> F</button>

			<br />

			<button onclick="switchCols(3,4);redraw();">G <-> H</button>
			<button onclick="switchCols(3,5);redraw();">G <-> I</button>
			<button onclick="switchCols(4,5);redraw();">H <-> I</button>

			<br />

			<button onclick="switchCols(6,7);redraw();">J <-> K</button>
			<button onclick="switchCols(6,8);redraw();">J <-> L</button>
			<button onclick="switchCols(7,8);redraw();">K <-> L</button>

			<br />

			<button onclick="switchRows(0,1);redraw();">p <-> q</button>
			<button onclick="switchRows(0,2);redraw();">p <-> r</button>
			<button onclick="switchRows(1,2);redraw();">q <-> r</button>

			<br />

			<button onclick="switchRows(3,4);redraw();">s <-> t</button>
			<button onclick="switchRows(3,5);redraw();">s <-> u</button>
			<button onclick="switchRows(4,5);redraw();">t <-> u</button>

			<br />

			<button onclick="switchRows(6,7);redraw();">v <-> x</button>
			<button onclick="switchRows(6,8);redraw();">v <-> y</button>
			<button onclick="switchRows(7,8);redraw();">x <-> y</button>

			<br />
			Num matches : <span id="numMatches">&nbsp;</span><br />
			Num matches : <span id="numMatchesPerDigit">&nbsp;</span><br />
			Status : <span id="status"></span><br/>
			<br />
			<label for="useLetters">Normalize with letters : <input type="checkbox" id="useLetters" onchange="redraw()"  value="true" /></label>
			<br/>
		</div>
		<script>

			String.prototype.replaceAll = function (search, replacement) {
				let target = this;
				return target.replace(new RegExp(search, 'g'), replacement);
			};

			let selectedDigit = 1
			
			$$(".num").map( e => {
				e.addEventListener("click", (event) => {
					selectedDigit = event.target.getAttribute("data-attr-digit")
					drawTarget()
					displayDigitMaps()
				} )
			})
			
			// hard
			let board =         "600020005 000108000 009030400 080000010 103060708 050000090 008040600 000709000 300010007".split(" ").join("")
			


			// 46 best match
			let targetBoard = 	"479132856538764192162598347254683971687915423913427685345871269726349518891256734".split(" ").join("");
			let numMatching = 0;
			let otherBoard = targetBoard
			let reArrangedBoard = "";
			let compareBoard = "";
			let numCompares = 0;
			let numMatchingPerDigit = [0,0,0,0,0,0,0,0,0];
			let boardDigitMaps = [0n,0n,0n, 0n,0n,0n, 0n,0n,0n ]
			
			let digitPositionMaps = new Set() // a set of 91 bits maps showing where a specific digit appears


			function drawTarget() {
				let b = otherBoard.split(" ").join("");
				let rep = "ABCDEFGHI";
				let str = b;

				compareBoard = str;

					let digits = str.split("");
					let rearrangedCells = document.querySelectorAll("#arranger .num");
					let compareCells = document.querySelectorAll("#original .num");
					numMatching = 0;
					numMatchingPerDigit = [0,0,0,0,0,0,0,0,0];
					for (let i = 0; i < digits.length; i++) {
						compareCells[i].innerHTML = digits[i] === "0" ? "":digits[i];
						compareCells[i].setAttribute("data-attr-digit",digits[i])
						if (compareCells[i].innerHTML === rearrangedCells[i].innerHTML) {
							numMatching++;
							const digit = parseInt(compareBoard.charAt(i))-1;
							numMatchingPerDigit[digit]++;
						}
					}
					document.querySelectorAll("#numMatches")[0].innerHTML = numMatching;
					document.querySelectorAll("#numMatchesPerDigit")[0].innerHTML = numMatchingPerDigit;
				
				
				$$(`[data-attr-digit]`).map(e => {
					e.setAttribute("class","num")
				})
			
				if( selectedDigit ) {
					$$(`[data-attr-digit='${selectedDigit}']`).map(e => {
						e.classList.add(`matches_8`)
					})
				}
			}

			function drawArranged() {
				let b = board.split(" ").join("");
				let rep = "ABCDEFGHI";
				let str = b;

				if (document.querySelectorAll("#useLetters")[0].checked) {
					for (let i = 0; i < 9; i++) {
						let c = b.charAt( (i % 3) + Math.floor(i / 3) * 9).toString();
						str = str.replaceAll(c, rep.charAt(i).toString());
					}
					let o = otherBoard.split(" ").join("");
					for (let i = 0; i < 9; i++) {
						let c = o.charAt( (i% 3) + Math.floor(i / 3) * 9).toString();
						str = str.replaceAll(str.charAt( (i% 3) + Math.floor(i / 3) * 9).toString(),c );
					}
				}

				let digits = str.split("");
				let cells = document.querySelectorAll("#arranger .num");
				for (let i = 0; i < digits.length; i++) {
					cells[i].innerHTML =  digits[i] === "0" ? "":digits[i];
					cells[i].setAttribute("data-attr-digit",digits[i])
				}
			}

			function switchVerticalGroups(g1, g2) {
				let orig = board.split("");
				let result = board.split("");
				for (let x = 0; x < 3; x++) {
					for (let y = 0; y < 9; y++) {
						result[g1 * 3 + x + y * 9] = orig[g2 * 3 + x + y * 9];
						result[g2 * 3 + x + y * 9] = orig[g1 * 3 + x + y * 9];
					}
				}
				board = result.join("");
			}

			function switchHorizontalGroups(g1, g2) {
				let orig = board.split("");
				let result = board.split("");
				for (let y = 0; y < 3; y++) {
					for (let x = 0; x < 9; x++) {
						result[g1 * 27 + x + y * 9] = orig[g2 * 27 + x + y * 9];
						result[g2 * 27 + x + y * 9] = orig[g1 * 27 + x + y * 9];
					}
				}

				board = result.join("");
			}

			function rotateLeft() {
				rotateRight();
				rotateRight();
				rotateRight();
			}

			function rotateRight() {
				let orig = board.split("");
				let result = board.split("");

				for (let y = 0; y < 9; y++) {
					for (let x = 0; x < 9; x++) {
						result[8 - y + x * 9] = orig[x + y * 9];
					}
				}
				board = result.join("");
			}

			function mirrorHorizontally() {
				let orig = board.split("");
				let result = board.split("");
				for (let y = 0; y < 9; y++) {
					for (let x = 0; x < 9; x++) {
						result[8 - x + y * 9] = orig[x + y * 9];
					}
				}
				board = result.join("");

			}

			function mirrorVertically() {
				let orig = board.split("");
				let result = board.split("");
				for (let y = 0; y < 9; y++) {
					for (let x = 0; x < 9; x++) {
						result[x + 8 * 9 - y * 9] = orig[x + y * 9];
					}
				}
				board = result.join("");

			}


			function flipOverTopRightBottomLeftDiagonal() {
				mirrorHorizontally();
				flipOverTopLeftBottomRightDiagonal();
				mirrorHorizontally();
			}

			function flipOverTopLeftBottomRightDiagonal() {
				let orig = board.split("");
				let result = board.split("");
				for (let y = 0; y < 9; y++) {
					for (let x = 0; x < 9; x++) {
						result[x * 9 + y] = orig[x + y * 9];
					}
				}
				board = result.join("");
			}

			function switchRows(r1, r2) {

				let orig = board.split("");
				let result = board.split("");

				for (let x = 0; x < 9; x++) {
					result[x + r1 * 9] = orig[x + r2 * 9];
					result[x + r2 * 9] = orig[x + r1 * 9];
				}

				board = result.join("");
			}

			function switchCols(c1, c2) {

				let orig = board.split("");
				let result = board.split("");

				for (let y = 0; y < 9; y++) {
					result[c1 + y * 9] = orig[c2 + y * 9];
					result[c2 + y * 9] = orig[c1 + y * 9];
				}

				board = result.join("");
			}


			function redraw() {
				drawArranged();
				drawTarget();
				displayDigitMaps()
			}

			
			let functions = [
				() => { switchVerticalGroups(0, 1) },
				() => { switchVerticalGroups(0, 2) },
				() => { switchVerticalGroups(1, 2) },
				() => { switchHorizontalGroups(0, 1) },
				() => { switchHorizontalGroups(0, 2) },
				() => { switchHorizontalGroups(1, 2) },
				() => { rotateRight() },
//				() => { mirrorHorizontally() },
//				() => { mirrorVertically() },
				() => { flipOverTopLeftBottomRightDiagonal() },
				() => { flipOverTopRightBottomLeftDiagonal() },
				() => { switchCols(0, 1) },
				() => { switchCols(0, 2) },
				() => { switchCols(1, 2) },
				() => { switchCols(3, 4) },
				() => { switchCols(3, 5) },
				() => { switchCols(4, 5) },
				() => { switchCols(6, 7) },
				() => { switchCols(6, 8) },
				() => { switchCols(7, 8) },
				() => { switchRows(0, 1) },
				() => { switchRows(0, 2) },
				() => { switchRows(1, 2) },
				() => { switchRows(3, 4) },
				() => { switchRows(3, 5) },
				() => { switchRows(4, 5) },
				() => { switchRows(6, 7) },
				() => { switchRows(6, 8) },
				() => { switchRows(7, 8) },
			];
			
		
			function displayDigitMaps(){
				makeDigitMaps()
				$("digitmaps").value = boardDigitMaps.map( n => n.toString()+"n," ).join("\n")
			}
			
			function makeDigitMaps() {
				boardDigitMaps 		 = [0n, 0n, 0n, 0n, 0n, 0n, 0n, 0n, 0n]
				
				for (let i = 0; i < 81; i++) {
					if( parseInt(board.charAt(i)) !== 0) {
						boardDigitMaps[parseInt(board.charAt(i)) - 1] |= BigInt(1) << BigInt(80 - i)
					}
				}
			}
			
			
			function $$(selector){
				return Array.from( document.querySelectorAll(selector) )
			}
			
			function $(id){
				return document.getElementById(id)
			}
			
			
			function pad( s ) {
				while (s.length < 81) s = "0" + s;
				return s;
			}
			
			
			redraw();

		</script>

	</body>

</html>